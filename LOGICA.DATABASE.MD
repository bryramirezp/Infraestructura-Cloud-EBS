# L√≥gica de Base de Datos - Plataforma Digital Escuela B√≠blica Salem

Este documento explica la estructura y l√≥gica de negocio de la base de datos para desarrolladores backend y frontend.

## üìê Modelo de Negocio

La estructura jer√°rquica del sistema es:

- **M√≥dulo:** Contenedor principal que agrupa materias. Define el per√≠odo acad√©mico (puede durar lo que determine la escuela).
  - Tiene `fecha_inicio` y `fecha_fin` que controlan cu√°ndo el contenido est√° disponible
  - Cuando el coordinador activa/publica el m√≥dulo, **todas las lecciones** se muestran autom√°ticamente
- **Materia:** Cada m√≥dulo tiene N materias (ej. "Jes√∫s 1", "Biblia 1"). Cada materia tiene:
  - N lecciones (ej. "Introducci√≥n a Jes√∫s", "Muerte y resurrecci√≥n de Jes√∫s")
  - Cada lecci√≥n tiene un quiz (tarea evaluable)
  - Un examen final (solo accesible despu√©s de completar todos los quizzes de las lecciones)

**Jerarqu√≠a:** M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n ‚Üí Quiz
**Examen Final:** M√≥dulo ‚Üí Materia ‚Üí Examen Final (requiere completar todos los quizzes)

**Control de Disponibilidad:**
- Las lecciones **NO tienen fechas propias** (`fecha_inicio`/`fecha_fin`)
- Las fechas del m√≥dulo controlan cu√°ndo todo el contenido est√° disponible
- Al activar el m√≥dulo, todas las lecciones se liberan simult√°neamente (no hay liberaci√≥n gradual)

---

## üîê 1. Usuarios y Acceso

Este grupo gestiona la identidad, autenticaci√≥n y permisos del sistema.

### **usuario**

**Descripci√≥n:** Tabla maestra de identidad. Almacena el perfil de cada usuario.

**Funci√≥n en el sistema:**
- Guarda informaci√≥n b√°sica: nombre, apellido, email
- `cognito_user_id`: Vincula el usuario con Amazon Cognito (autenticaci√≥n externa)
- `avatar_url`: URL del avatar del usuario

**L√≥gica Clave:**
- **RLS:** Los usuarios solo pueden ver y actualizar su propio perfil. Los administradores tienen acceso completo.
- **Integraci√≥n Cognito:** El backend debe establecer la variable de sesi√≥n `app.current_cognito_user_id` antes de cada query para que RLS funcione correctamente.

### **rol**

**Descripci√≥n:** Cat√°logo de roles disponibles (ej. 'ADMIN', 'INSTRUCTOR', 'ESTUDIANTE').

**Funci√≥n en el sistema:**
- Define los niveles de permiso del sistema
- `nombre` es √∫nico y se usa para identificar roles (ej. `is_admin()` busca `nombre = 'ADMIN'`)

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden ver y gestionar roles
- **UUID:** Usa UUID como PK, pero `nombre` es √∫nico para b√∫squedas humanas

### **usuario_rol**

**Descripci√≥n:** Tabla pivote (muchos a muchos) que asigna roles a usuarios.

**Funci√≥n en el sistema:**
- Determina qu√© puede hacer un usuario en el sistema
- La funci√≥n `is_admin()` consulta esta tabla para otorgar permisos elevados

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar asignaciones de roles
- **UNIQUE:** Un usuario no puede tener el mismo rol duplicado

---

## üìö 2. Contenido del M√≥dulo y Materias

Este grupo define la estructura jer√°rquica y los materiales de aprendizaje.

### **modulo**

**Descripci√≥n:** Entidad principal. Contenedor de m√°s alto nivel que agrupa materias. Define el per√≠odo acad√©mico (puede durar lo que determine la escuela).

**Funci√≥n en el sistema:**
- Agrupa materias relacionadas (ej. "Jes√∫s 1" y "Biblia 1")
- `fecha_inicio` y `fecha_fin`: Define el per√≠odo del m√≥dulo y controla cu√°ndo todo el contenido est√° disponible
- `publicado`: Controla visibilidad (cuando el coordinador activa el m√≥dulo)

**L√≥gica Clave:**
- **CHECK:** `fecha_fin >= fecha_inicio` (validaci√≥n autom√°tica)
- **RLS:** M√≥dulos publicados son visibles para todos. Solo administradores pueden crear/editar.
- **Jerarqu√≠a:** M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n
- **Control de disponibilidad:** Cuando el m√≥dulo est√° activo/publicado, **todas las lecciones** de todas las materias del m√≥dulo se muestran autom√°ticamente
- **Sin liberaci√≥n gradual:** Las lecciones no tienen fechas individuales; se liberan todas al activar el m√≥dulo

### **curso**

**Descripci√≥n:** Materia dentro de un m√≥dulo (ej. "Jes√∫s 1", "Biblia 1"). Cada m√≥dulo puede tener m√∫ltiples materias.

**Funci√≥n en el sistema:**
- Agrupa lecciones y quizzes de una materia espec√≠fica
- `publicado`: Controla la visibilidad p√∫blica de la materia
- Vinculada a m√≥dulo a trav√©s de `modulo_curso`

**L√≥gica Clave:**
- **RLS:** Materias publicadas son visibles si el m√≥dulo tambi√©n est√° publicado
- **Jerarqu√≠a:** M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n
- **Nota:** La tabla se llama `curso` pero conceptualmente representa una "Materia"

### **modulo_curso**

**Descripci√≥n:** Tabla pivote (muchos a muchos) que vincula m√≥dulos con materias.

**Funci√≥n en el sistema:**
- Permite que un m√≥dulo tenga m√∫ltiples materias (ej. un m√≥dulo puede tener "Jes√∫s 1" y "Biblia 1")
- `slot`: Define el orden de la materia dentro del m√≥dulo
- Un m√≥dulo puede tener m√∫ltiples materias, y una materia puede estar en m√∫ltiples m√≥dulos

**L√≥gica Clave:**
- **UNIQUE:** `(modulo_id, slot)` garantiza orden √∫nico por m√≥dulo
- **UNIQUE:** `(modulo_id, curso_id)` evita duplicados
- **RLS:** Solo administradores pueden gestionar esta tabla

### **leccion**

**Descripci√≥n:** P√°gina de contenido espec√≠fica dentro de una materia (ej. "Introducci√≥n a Jes√∫s", "Muerte y resurrecci√≥n de Jes√∫s").

**Funci√≥n en el sistema:**
- Contenido educativo individual de una materia
- Vinculada a `modulo_id`, creando la jerarqu√≠a: M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n
- `orden`: Define el orden dentro del m√≥dulo
- **NO tiene fechas propias:** Las lecciones no tienen `fecha_inicio` ni `fecha_fin`

**L√≥gica Clave:**
- **RLS:** Lecciones publicadas son visibles si el m√≥dulo y la materia tambi√©n est√°n publicados
- **Jerarqu√≠a:** Las lecciones pertenecen a un m√≥dulo, y se asocian a materias a trav√©s de la relaci√≥n m√≥dulo-materia
- **Disponibilidad:** Cuando el coordinador activa/publica un m√≥dulo, **todas las lecciones** del m√≥dulo se muestran autom√°ticamente
- **Control temporal:** Las fechas `fecha_inicio` y `fecha_fin` del m√≥dulo controlan cu√°ndo el contenido est√° disponible, no las lecciones individuales

### **leccion_contenido**

**Descripci√≥n:** Bloques de contenido reales (texto, video, PDF, link) dentro de una lecci√≥n.

**Funci√≥n en el sistema:**
- Permite construir una lecci√≥n a partir de m√∫ltiples piezas de contenido
- `tipo`: TEXTO, PDF, VIDEO, LINK
- `orden`: Define el orden de los bloques dentro de la lecci√≥n

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar contenido
- **CASCADE:** Si se elimina una lecci√≥n, se eliminan todos sus contenidos

### **guia_estudio**

**Descripci√≥n:** Recursos a nivel de materia (ej. "Programa de la Materia" o "Bibliograf√≠a").

**Funci√≥n en el sistema:**
- Proporciona materiales de apoyo que aplican a toda la materia
- `activo`: Controla si el recurso est√° disponible

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar gu√≠as de estudio
- **CASCADE:** Si se elimina una materia (curso), se eliminan sus gu√≠as

---

## üìù 3. Evaluaciones y Calificaciones

Este grupo maneja c√≥mo se eval√∫a a los estudiantes.

### **quiz**

**Descripci√≥n:** Tarea evaluable (quiz) vinculada a una lecci√≥n espec√≠fica. Cada lecci√≥n tiene un quiz asociado.

**Funci√≥n en el sistema:**
- Agrupa un conjunto de preguntas para evaluar el contenido de una lecci√≥n
- Es la "tarea" evaluable de cada lecci√≥n
- Cada lecci√≥n tiene un quiz asociado
- `publicado`: Controla visibilidad
- `aleatorio`: Indica si las preguntas se muestran en orden aleatorio
- `guarda_calificacion`: Define si se guarda la calificaci√≥n

**L√≥gica Clave:**
- **RLS:** Quizzes publicados son visibles si la lecci√≥n, materia y m√≥dulo tambi√©n est√°n publicados
- **Vista:** `quiz_con_preguntas` calcula din√°micamente el n√∫mero de preguntas
- **Jerarqu√≠a:** M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n ‚Üí Quiz
- **Vinculaci√≥n:** Vinculado a `leccion_id` (no a `curso_id`)
- **Nota:** Los quizzes son las tareas evaluables del sistema; cada lecci√≥n tiene su quiz

### **pregunta**

**Descripci√≥n:** Enunciado de una pregunta dentro de un quiz.

**Funci√≥n en el sistema:**
- Almacena el texto de la pregunta
- `puntos`: Puntos que vale la pregunta
- `orden`: Orden dentro del quiz

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar preguntas
- **RESTRICT:** No se puede eliminar una pregunta si tiene intentos asociados

### **pregunta_config**

**Descripci√≥n:** Configuraci√≥n espec√≠fica seg√∫n el tipo de pregunta.

**Funci√≥n en el sistema:**
- Define el tipo: ABIERTA, OPCION_MULTIPLE, VERDADERO_FALSO
- Almacena configuraci√≥n espec√≠fica seg√∫n el tipo:
  - **ABIERTA:** `abierta_modelo_respuesta` (texto de referencia)
  - **OPCION_MULTIPLE:** `om_min_selecciones`, `om_max_selecciones`, `puntos_por_opcion`
  - **VERDADERO_FALSO:** `vf_respuesta_correcta`
- `penaliza_error`: Define si se penaliza por respuesta incorrecta

**L√≥gica Clave:**
- **CHECK:** Restricciones que validan que los campos requeridos est√©n presentes seg√∫n el tipo
- **CHECK:** `om_min_selecciones <= om_max_selecciones`
- **Trigger:** `validar_respuesta_tipo` asegura que las respuestas coincidan con el tipo

### **opcion**

**Descripci√≥n:** Opciones de respuesta para preguntas de opci√≥n m√∫ltiple.

**Funci√≥n en el sistema:**
- Almacena las opciones disponibles
- `es_correcta`: Indica si la opci√≥n es correcta
- `orden`: Orden de presentaci√≥n

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar opciones
- **SET NULL:** Si se elimina una opci√≥n, las respuestas que la usaban quedan con `opcion_id = NULL`

### **examen_final**

**Descripci√≥n:** Examen final de la materia. Solo se puede realizar despu√©s de completar todos los quizzes de las lecciones.

**Funci√≥n en el sistema:**
- Evaluaci√≥n final que determina la acreditaci√≥n de la materia
- Vinculado directamente a una materia (curso)
- `publicado`: Controla visibilidad
- `aleatorio`: Indica si las preguntas se muestran en orden aleatorio
- `guarda_calificacion`: Define si se guarda la calificaci√≥n

**L√≥gica Clave:**
- **RLS:** Ex√°menes publicados son visibles si la materia tambi√©n est√° publicada
- **Prerequisito:** El alumno solo puede acceder al examen final si complet√≥ todos los quizzes de todas las lecciones de la materia
- **Validaci√≥n:** El sistema debe validar que todos los quizzes de las lecciones de la materia est√©n completados antes de permitir el intento
- **Jerarqu√≠a:** M√≥dulo ‚Üí Materia ‚Üí Examen Final
- **Vinculaci√≥n:** Vinculado a `curso_id` (materia)

---

## üéì 4. Inscripci√≥n y Progreso

Este grupo rastrea el viaje y los logros del estudiante.

### **inscripcion_curso**

**Descripci√≥n:** La "matr√≠cula". Vincula un usuario a una materia (curso).

**Funci√≥n en el sistema:**
- Tabla central de progreso del estudiante en una materia
- Almacena estado: ACTIVA, PAUSADA, CONCLUIDA, REPROBADA
- `acreditado`: Indica si la materia fue completada exitosamente
- `acreditado_en`: Timestamp de acreditaci√≥n
- `fecha_inscripcion`, `fecha_conclusion`: Fechas importantes

**L√≥gica Clave:**
- **RLS:** Usuarios solo pueden ver y gestionar sus propias inscripciones
- **UNIQUE:** Un usuario solo puede estar inscrito una vez por materia
- **CHECK:** `fecha_conclusion >= fecha_inscripcion`
- **Triggers:**
  - `validar_transicion_estado_inscripcion`: Previene transiciones inv√°lidas (ej. CONCLUIDA no puede cambiar)
  - `validar_acreditacion_curso`: Valida que exista un intento aprobado con score m√≠nimo antes de acreditar
- **DEFAULT:** Estado inicial es 'ACTIVA'
- **Nota:** La tabla se llama `inscripcion_curso` pero conceptualmente representa inscripci√≥n a una "Materia"

### **inscripcion_modulo_calculada** (Vista)

**Descripci√≥n:** Vista que calcula el progreso del m√≥dulo bas√°ndose en las inscripciones de materias (cursos).

**Funci√≥n en el sistema:**
- Reemplaza la antigua tabla `inscripcion_modulo` (eliminada por redundancia)
- Calcula din√°micamente: estado, acreditado, fechas
- El progreso del m√≥dulo se deriva del progreso en las materias que lo componen

**L√≥gica Clave:**
- **Estado:** Prioridad REPROBADA > CONCLUIDA > PAUSADA > ACTIVA
- **Acreditado:** TRUE solo si todas las materias del m√≥dulo est√°n acreditadas Y el usuario est√° inscrito en todas
- **Uso:** Consultar esta vista en lugar de una tabla para obtener el progreso del m√≥dulo

### **intento**

**Descripci√≥n:** Un intento de un usuario para resolver un quiz o examen final.

**Funci√≥n en el sistema:**
- Registra cada intento con su puntaje y resultado (APROBADO, NO_APROBADO)
- Puede ser para un quiz de lecci√≥n o para un examen final de materia
- `numero_intento`: N√∫mero secuencial del intento
- `puntaje`: Calificaci√≥n num√©rica (NUMERIC(5,2))
- `iniciado_en`, `finalizado_en`: Timestamps del intento
- `permitir_nuevo_intento`: Campo booleano controlado por el instructor para permitir un nuevo intento

**L√≥gica Clave:**
- **RLS:** Usuarios solo ven sus propios intentos
- **M√∫ltiples intentos:** Un usuario puede tener m√∫ltiples intentos por quiz (se elimin√≥ la restricci√≥n UNIQUE que limitaba intentos)
- **Control manual:** El instructor debe establecer `permitir_nuevo_intento = TRUE` para que el usuario pueda crear un nuevo intento
- **Cada intento es independiente:** Cada intento tiene su propio registro completo
- **Triggers:**
  - `validar_max_intentos`: Valida que no se exceda el m√°ximo seg√∫n `regla_acreditacion` (si est√° configurado)
  - `validar_intento_inscripcion`: Asegura que el usuario est√© inscrito y el quiz pertenezca a la lecci√≥n/materia
  - `validar_examen_final_prerequisitos`: Valida que todos los quizzes de las lecciones est√©n completados antes de permitir el examen final
  - `validar_nuevo_intento_permitido`: Valida que `permitir_nuevo_intento = TRUE` antes de crear un nuevo intento
- **NO ACTION:** `usuario_id` no se elimina si se borra el usuario (preserva historial)
- **Reapertura:** El instructor controla manualmente cu√°ndo permitir nuevos intentos estableciendo `permitir_nuevo_intento = TRUE`

### **intento_pregunta**

**Descripci√≥n:** "Snapshot" de las preguntas en un intento espec√≠fico.

**Funci√≥n en el sistema:**
- Captura el estado de las preguntas al momento del intento
- `puntos_maximos`: Puntos m√°ximos que val√≠a la pregunta en ese momento
- Preserva el historial incluso si las preguntas cambian despu√©s

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden ver estas respuestas (protege integridad del banco)
- **UNIQUE:** `(intento_id, pregunta_id)` previene duplicados
- **RESTRICT:** No se puede eliminar una pregunta si tiene intentos asociados

### **respuesta**

**Descripci√≥n:** Respuesta espec√≠fica del usuario a una pregunta.

**Funci√≥n en el sistema:**
- Almacena la respuesta seg√∫n el tipo:
  - **ABIERTA:** `respuesta_texto`
  - **OPCION_MULTIPLE:** `opcion_id`
  - **VERDADERO_FALSO:** `respuesta_bool`

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden ver respuestas
- **Trigger:** `validar_respuesta_tipo` asegura que el tipo de respuesta coincida con el tipo de pregunta
- **Vista:** `respuesta_con_evaluacion` calcula din√°micamente `es_correcta` y `puntos_otorgados`

### **regla_acreditacion**

**Descripci√≥n:** Define las reglas de negocio para aprobar una materia (curso).

**Funci√≥n en el sistema:**
- Configuraci√≥n de evaluaci√≥n: score m√≠nimo, m√°ximo de intentos
- `quiz_id`: NULL para reglas generales de la materia, o espec√≠fico para un quiz/examen final
- `activa`: Permite desactivar reglas sin eliminarlas
- Puede aplicarse a quizzes de lecciones o al examen final

**L√≥gica Clave:**
- **RLS:** Solo administradores pueden gestionar reglas
- **UNIQUE parcial:** Solo una regla activa por materia (o por materia+quiz/examen)
- **Prioridad:** Reglas espec√≠ficas por quiz/examen tienen prioridad sobre reglas generales
- **Default:** Si no hay regla, se usa 80% de score m√≠nimo y 3 intentos m√°ximo
- **Examen final:** Las reglas del examen final determinan la acreditaci√≥n de la materia

### **certificado**

**Descripci√≥n:** Registro de un certificado emitido.

**Funci√≥n en el sistema:**
- Se vincula a una `inscripcion_curso` exitosa
- `folio`: N√∫mero de folio del certificado
- `hash_verificacion`: Hash √∫nico para verificaci√≥n
- `s3_key`: Ubicaci√≥n del archivo en S3
- `quiz_id`, `intento_id`: Referencias para auditor√≠a

**L√≥gica Clave:**
- **RLS:** Usuarios solo pueden ver sus propios certificados
- **UNIQUE parcial:** Solo un certificado v√°lido por inscripci√≥n
- **SET NULL:** Si se elimina el quiz/intento, se mantiene el certificado pero se pierden las referencias

---

## üí¨ 5. Interacci√≥n

Este grupo maneja la comunicaci√≥n entre usuarios.

### **foro_comentario**

**Descripci√≥n:** Comentarios p√∫blicos para una lecci√≥n.

**Funci√≥n en el sistema:**
- Permite discusi√≥n p√∫blica sobre lecciones
- Vinculado a `curso_id` (materia) y `leccion_id`

**L√≥gica Clave:**
- **RLS:** Solo puedes ver/publicar comentarios si est√°s inscrito en la materia
- **Trigger:** `validar_foro_comentario_curso` asegura que `curso_id` coincida con la materia del m√≥dulo de la lecci√≥n
- **CASCADE:** Si se elimina materia/lecci√≥n/usuario, se eliminan sus comentarios

### **preferencia_notificacion**

**Descripci√≥n:** Configuraci√≥n de notificaciones por email (1-a-1 con usuario).

**Funci√≥n en el sistema:**
- Controla qu√© notificaciones desea recibir el usuario
- `email_recordatorios`, `email_motivacion`, `email_resultados`: Flags booleanos

**L√≥gica Clave:**
- **RLS:** Usuarios solo pueden ver y editar sus propias preferencias
- **UNIQUE:** Un usuario solo puede tener un registro de preferencias

---

## ‚öôÔ∏è 6. Vistas e √çndices

Este grupo no almacena datos, sino que los calcula o acelera.

### **Vistas (Views)**

#### **inscripcion_modulo_calculada**

**Descripci√≥n:** Calcula el progreso del m√≥dulo bas√°ndose en inscripciones de materias (cursos).

**Funci√≥n:**
- Reemplaza la tabla `inscripcion_modulo` (eliminada)
- Calcula din√°micamente: estado, acreditado, fechas
- El progreso se deriva del progreso en las materias que componen el m√≥dulo

**Uso:**
```sql
SELECT * FROM inscripcion_modulo_calculada 
WHERE usuario_id = '...' AND modulo_id = '...';
```

#### **respuesta_con_evaluacion**

**Descripci√≥n:** Autocalifica respuestas compar√°ndolas con la configuraci√≥n de la pregunta.

**Funci√≥n:**
- Calcula `es_correcta` y `puntos_otorgados` din√°micamente
- Maneja los tres tipos de pregunta (ABIERTA, OPCION_MULTIPLE, VERDADERO_FALSO)
- Considera penalizaciones por error

**Uso:**
```sql
SELECT * FROM respuesta_con_evaluacion 
WHERE intento_pregunta_id = '...';
```

#### **quiz_con_preguntas**

**Descripci√≥n:** Agrega el conteo de preguntas a cada quiz.

**Funci√≥n:**
- Calcula din√°micamente `numero_preguntas`
- Evita almacenar datos redundantes

**Uso:**
```sql
SELECT * FROM quiz_con_preguntas WHERE id = '...';
```

### **√çndices (Indexes)**

**Funci√≥n en el sistema:** Aceleran las b√∫squedas y mejoran el rendimiento.

**Tipos de √≠ndices:**

1. **√çndices B-Tree (FKs):** En todas las claves for√°neas (30+ √≠ndices)
   - Mejoran JOINs y b√∫squedas por FK

2. **√çndices parciales:** Para valores booleanos frecuentes
   - Ej: `WHERE publicado = TRUE`, `WHERE acreditado = TRUE`
   - M√°s eficientes que √≠ndices completos

3. **√çndices compuestos:** Para consultas comunes
   - Ej: `(usuario_id, estado)`, `(curso_id, leccion_id)`
   - Optimizan filtros m√∫ltiples

4. **√çndices de ordenamiento:** Para ORDER BY frecuentes
   - Ej: `(modulo_id, orden)`, `(leccion_id, creado_en DESC)`

5. **√çndices GIN (pg_trgm):** Para b√∫squeda de texto completo
   - 12 √≠ndices en t√≠tulos, descripciones y contenidos
   - Permiten b√∫squedas tipo "LIKE" optimizadas
   - Uso: `WHERE titulo % 'palabra clave'`

---

## üîí 7. Seguridad y Autenticaci√≥n

### **Row-Level Security (RLS)**

**Funci√≥n:** Controla el acceso a nivel de fila bas√°ndose en el usuario actual.

**Implementaci√≥n:**
- RLS habilitado en 22 tablas
- Funciones helper:
  - `get_current_user_id()`: Obtiene el UUID del usuario desde `cognito_user_id` (variable de sesi√≥n)
  - `is_admin()`: Verifica si el usuario tiene rol 'ADMIN'

**Integraci√≥n con Cognito:**
- El backend debe establecer `app.current_cognito_user_id` antes de cada query
- Ejemplo (SQLAlchemy):
  ```python
  session.execute(text("SET app.current_cognito_user_id = :cognito_id"), 
                  {"cognito_id": cognito_user_id})
  ```

**Pol√≠ticas comunes:**
- Usuarios solo ven/editan sus propios datos
- Contenido p√∫blico es visible para todos
- Administradores tienen acceso completo
- Contenido de materia requiere inscripci√≥n

### **Triggers de Validaci√≥n**

**Funci√≥n:** Aplican reglas de negocio a nivel de base de datos.

**Triggers principales:**
- `validar_max_intentos`: Limita intentos seg√∫n reglas de acreditaci√≥n
- `validar_intento_inscripcion`: Valida que el usuario est√© inscrito y el quiz pertenezca a la lecci√≥n/materia
- `validar_examen_final_prerequisitos`: Valida que todos los quizzes de las lecciones est√©n completados antes de permitir el examen final
- `validar_nuevo_intento_permitido`: Valida que `permitir_nuevo_intento = TRUE` antes de crear un nuevo intento
- `validar_respuesta_tipo`: Asegura que el tipo de respuesta coincida con el tipo de pregunta
- `validar_transicion_estado_inscripcion`: Previene transiciones inv√°lidas de estado
- `validar_acreditacion_curso`: Valida requisitos antes de acreditar
- `validar_foro_comentario_curso`: Valida consistencia entre materia y lecci√≥n

---

## üìã 8. Convenciones y Tipos

### **Tipos ENUM**

- `estado_publicacion`: PUBLICADO, NO_PUBLICADO
- `tipo_contenido`: TEXTO, PDF, VIDEO, LINK
- `estado_inscripcion`: ACTIVA, PAUSADA, CONCLUIDA, REPROBADA
- `resultado_intento`: APROBADO, NO_APROBADO
- `tipo_pregunta`: ABIERTA, OPCION_MULTIPLE, VERDADERO_FALSO

### **Convenciones de Nomenclatura**

- **Tablas:** Singular, espa√±ol (usuario, curso/materia, modulo, leccion)
- **Columnas:** Espa√±ol (creado_en, actualizado_en, titulo)
- **Timestamps:** `creado_en`, `actualizado_en` (TIMESTAMPTZ)
- **IDs:** UUID para todas las claves primarias
- **Foreign Keys:** `tabla_id` (ej. `curso_id`, `usuario_id`)

### **Pol√≠ticas ON DELETE/UPDATE**

- **CASCADE:** Relaciones de dependencia (ej. usuario_rol, modulo_curso)
- **RESTRICT:** Entidades principales (ej. curso/materia, modulo, quiz)
- **SET NULL:** Referencias opcionales
- **NO ACTION:** Datos hist√≥ricos (ej. usuario_id en intento)

---

## üöÄ 9. Consideraciones para Desarrollo

### **Backend**

1. **Autenticaci√≥n:**
   - Validar JWT de Cognito
   - Extraer `sub` claim (cognito_user_id)
   - Establecer `app.current_cognito_user_id` antes de cada query

2. **Consultas:**
   - Usar vistas calculadas cuando sea apropiado (`inscripcion_modulo_calculada`, `respuesta_con_evaluacion`)
   - Los triggers validan reglas de negocio autom√°ticamente
   - Manejar excepciones de triggers (ej. nuevo intento no permitido)

3. **M√∫ltiples intentos:**
   - Los usuarios pueden tener m√∫ltiples intentos por quiz
   - El instructor debe establecer `permitir_nuevo_intento = TRUE` para permitir un nuevo intento
   - Cada intento tiene su propio registro independiente

4. **B√∫squedas de texto:**
   - Usar operador `%` con √≠ndices GIN: `WHERE titulo % 'palabra clave'`
   - Usar `similarity()` para ranking: `ORDER BY similarity(titulo, 'palabra') DESC`

### **Frontend**

1. **Estados de inscripci√≥n:**
   - ACTIVA: Usuario puede continuar
   - PAUSADA: Usuario paus√≥ la materia
   - CONCLUIDA: Materia completada exitosamente
   - REPROBADA: Materia no completada

2. **Progreso de m√≥dulo:**
   - Consultar `inscripcion_modulo_calculada` en lugar de tabla
   - El progreso se calcula din√°micamente bas√°ndose en las materias del m√≥dulo

3. **Jerarqu√≠a del contenido:**
   - M√≥dulo ‚Üí Materia ‚Üí Lecci√≥n ‚Üí Quiz (tarea evaluable)
   - M√≥dulo ‚Üí Materia ‚Üí Examen Final
   - Cada lecci√≥n tiene un quiz (tarea evaluable)
   - Cada materia tiene un examen final

4. **M√∫ltiples intentos:**
   - Los usuarios pueden tener m√∫ltiples intentos en quizzes
   - El instructor controla manualmente cu√°ndo permitir nuevos intentos estableciendo `permitir_nuevo_intento = TRUE`
   - Cada intento es un registro independiente con su propia calificaci√≥n

5. **Acceso al examen final:**
   - El alumno solo puede acceder al examen final si complet√≥ todos los quizzes de todas las lecciones de la materia
   - El sistema valida autom√°ticamente este prerequisito antes de permitir el intento

6. **Disponibilidad de lecciones:**
   - Las lecciones NO tienen fechas individuales
   - Cuando el coordinador activa/publica un m√≥dulo, todas las lecciones se muestran autom√°ticamente
   - Las fechas `fecha_inicio` y `fecha_fin` del m√≥dulo controlan el per√≠odo de disponibilidad

---

## üìù Notas Finales

- **Sin datos redundantes:** El progreso se calcula din√°micamente (vistas)
- **Sin datos hu√©rfanos:** Triggers limpian referencias autom√°ticamente
- **Seguridad a nivel de fila:** RLS protege datos sensibles
- **Validaci√≥n autom√°tica:** Triggers aplican reglas de negocio
- **Rendimiento optimizado:** 60+ √≠ndices para consultas r√°pidas

Para m√°s detalles t√©cnicos, consultar `AUDITORIA_BASE_DATOS.md`.

